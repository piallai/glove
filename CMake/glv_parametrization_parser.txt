# 
# This file is part of the Glove distribution (https://github.com/piallai/glove).
# Copyright (C) 2024 - 2025 Pierre Allain.
# 
# This program is free software: you can redistribute it and/or modify  
# it under the terms of the GNU General Public License as published by  
# the Free Software Foundation, version 3.
#
# This program is distributed in the hope that it will be useful, but 
# WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU 
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License 
# along with this program. If not, see <http://www.gnu.org/licenses/>.
#

function(GLV_PARAMETRIZATION_PARSER INPUT_PARAMETRIZATION_JSON OUTPUT_PARAMETRIZATION_FILE)

	file(READ ${INPUT_PARAMETRIZATION_JSON} JSON_STRING)

	set(IS_PARAMETRIZATION_INIT FALSE)
	set(IS_PARAMETER_INIT TRUE)
	set(PARAMETRIZATION_NAME_INIT "")
	set(PARAMETER_INDEX_INIT -1)
	set(PARAMETRIZATIONS "" CACHE INTERNAL "")
	glv_json_parser(JSON_STRING IS_PARAMETRIZATION_INIT IS_PARAMETER_INIT PARAMETRIZATION_NAME_INIT PARAMETER_INDEX_INIT)

	file(WRITE ${OUTPUT_PARAMETRIZATION_FILE} "/* This file was generated by CMake/glv_parametrization_parser.*/\n")
	file(APPEND ${OUTPUT_PARAMETRIZATION_FILE} "#pragma once\n\n")
	glv_write_parametrization_file(${OUTPUT_PARAMETRIZATION_FILE})

endfunction()


#_IS_PARAMETRIZATION whether if directly inside of a parametrization
function(GLV_JSON_PARSER _JSON_STRING _IS_PARAMETRIZATION _IS_PARAMETER _PARAMETRIZATION_NAME _PARAMETER_INDEX)

	set(JSON_STRING ${${_JSON_STRING}})

	set(IS_PARAMETRIZATION ${${_IS_PARAMETRIZATION}})
	set(IS_PARAMETER ${${_IS_PARAMETER}})
	set(PARAMETRIZATION_NAME ${${_PARAMETRIZATION_NAME}})
	set(PARAMETER_INDEX ${${_PARAMETER_INDEX}})

	string(SUBSTRING ${JSON_STRING} 0 1 JSON_FIRST_CHAR)
	if (${JSON_FIRST_CHAR} STREQUAL "{") # Check if it is json string. Workaround

		string(JSON JSON_LENGTH LENGTH ${JSON_STRING})
		MATH(EXPR FOR_JSON_LENGTH "${JSON_LENGTH}-1")

		if (${IS_PARAMETRIZATION})
			set(PARAMETRIZATIONS ${PARAMETRIZATIONS} ${PARAMETRIZATION_NAME} CACHE INTERNAL "")
			set(${PARAMETRIZATION_NAME}_Nparameters ${JSON_LENGTH} CACHE INTERNAL "")
		endif()

		foreach(index RANGE ${FOR_JSON_LENGTH})
		
			string(JSON JSON_MEMBER MEMBER ${JSON_STRING} ${index})
			string(JSON JSON_VAR GET ${JSON_STRING} ${JSON_MEMBER})

			if (NOT ${JSON_VAR} STREQUAL "")
			
				string(SUBSTRING ${JSON_VAR} 0 1 JSON_VAR_FIRST_CHAR)

				if (${JSON_VAR_FIRST_CHAR} STREQUAL "{") # then recursion happens
				
					if (${IS_PARAMETRIZATION})# if this a parametrization, then json member correspond to a parameter
						set(__IS_PARAMETRIZATION FALSE) #if false then is the list of members for the parameter
						set(__IS_PARAMETER TRUE)
						set(__PARAMETRIZATION_NAME ${PARAMETRIZATION_NAME})

						set(PARAMETRIZATION_${PARAMETRIZATION_NAME}_PARAM${index}_name ${JSON_MEMBER} CACHE INTERNAL "")
					else()
						if (${IS_PARAMETER})
							set(__IS_PARAMETRIZATION TRUE)
							set(__IS_PARAMETER FALSE)
							set(PARAMETRIZATION_PARAMETER_NAME ${JSON_MEMBER})
						else()
							set(__IS_PARAMETRIZATION FALSE)
							set(__IS_PARAMETER TRUE)
						endif()
						set(__PARAMETRIZATION_NAME ${JSON_MEMBER})
					endif()

					set(__PARAMETER_INDEX ${index})

					glv_json_parser(JSON_VAR __IS_PARAMETRIZATION __IS_PARAMETER __PARAMETRIZATION_NAME __PARAMETER_INDEX)

				else()

					if (NOT ${IS_PARAMETRIZATION} AND ${IS_PARAMETER})
							set(PARAMETRIZATION_${PARAMETRIZATION_NAME}_PARAM${PARAMETER_INDEX}_${JSON_MEMBER} ${JSON_VAR} CACHE INTERNAL "")
					endif()

				endif()

			endif()
			
		endforeach()

		#############
		# Special case for parameter which is implicitly a parametrization: some fields are automatically filled
		if (NOT ${IS_PARAMETRIZATION} AND ${IS_PARAMETER})
			if (NOT DEFINED PARAMETRIZATION_${PARAMETRIZATION_NAME}_PARAM${PARAMETER_INDEX}_type)
				if (NOT ${PARAMETER_INDEX} STREQUAL "-1")# special init case
					set(PARAMETRIZATION_${PARAMETRIZATION_NAME}_PARAM${PARAMETER_INDEX}_type ${PARAMETRIZATION_PARAMETER_NAME} CACHE INTERNAL "")
					set(PARAMETRIZATION_${PARAMETRIZATION_NAME}_PARAM${PARAMETER_INDEX}_value "${PARAMETRIZATION_PARAMETER_NAME}()" CACHE INTERNAL "")
					set(PARAMETRIZATION_${PARAMETRIZATION_NAME}_PARAM${PARAMETER_INDEX}_var_name "${PARAMETRIZATION_PARAMETER_NAME}_var" CACHE INTERNAL "")
				endif()
			endif()
		endif()

	endif()

endfunction()


function(GLV_WRITE_PARAMETRIZATION_FILE parametrization_file)

	list(REVERSE PARAMETRIZATIONS) # reverse for 'deepest' parametrizations first
	
	foreach(Parametrization_name ${PARAMETRIZATIONS})
	
		file(APPEND ${parametrization_file} "glvm_parametrization(" ${Parametrization_name} ",\"${Parametrization_name}\", \n")

		MATH(EXPR FOR_NPARAMETERS "${${Parametrization_name}_Nparameters}-1")
		
		foreach(Parameter_index RANGE ${FOR_NPARAMETERS})
		
			file(APPEND ${parametrization_file} "\t")
			file(APPEND ${parametrization_file} ${PARAMETRIZATION_${Parametrization_name}_PARAM${Parameter_index}_var_name} ", ")
			file(APPEND ${parametrization_file} ${PARAMETRIZATION_${Parametrization_name}_PARAM${Parameter_index}_type} ", ")
			file(APPEND ${parametrization_file} "\"${PARAMETRIZATION_${Parametrization_name}_PARAM${Parameter_index}_name}\", ")
			file(APPEND ${parametrization_file} "\"${PARAMETRIZATION_${Parametrization_name}_PARAM${Parameter_index}_description}\", ")

			set(PARAM_TYPE ${PARAMETRIZATION_${Parametrization_name}_PARAM${Parameter_index}_type})
			set(PARAM_VALUE ${PARAMETRIZATION_${Parametrization_name}_PARAM${Parameter_index}_value})

			if (${PARAM_TYPE} STREQUAL "bool")
				if (${PARAM_VALUE})
					file(APPEND ${parametrization_file} "true")
				else()
					file(APPEND ${parametrization_file} "false")
				endif()
			elseif(${PARAM_TYPE} STREQUAL "string" OR ${PARAM_TYPE} STREQUAL "SlvFile" OR ${PARAM_TYPE} STREQUAL "SlvDirectory")
				file(APPEND ${parametrization_file} "\"${PARAM_VALUE}\"")
			else()
				file(APPEND ${parametrization_file} ${PARAM_VALUE})
				if (${PARAM_TYPE} STREQUAL "float")
					file(APPEND ${parametrization_file} "f")
				endif()
			endif()

			if (${Parameter_index} STREQUAL ${FOR_NPARAMETERS})
				file(APPEND ${parametrization_file} ")")
			else()
				file(APPEND ${parametrization_file} ",")
			endif()
			file(APPEND ${parametrization_file} "\n")

		endforeach()
		
		file(APPEND ${parametrization_file} "\n")

	endforeach()

endfunction()

